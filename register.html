<script>
    const SUPABASE_URL = "https://bxufacemathzdfqzmlad.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4dWZhY2VtYXRoemRmcXptbGFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMTg0NTYsImV4cCI6MjA3Mzg5NDQ1Nn0.BFogsvLqjVH_TX-WsOcFYl0AopUkELwN0BhuJ2O0lwU";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM Elements
    const errorAlert = document.getElementById("errorAlert");
    const successAlert = document.getElementById("successAlert");
    const submitBtn = document.getElementById("submitBtn");
    const progressBar = document.querySelector(".progress-bar");
    
    // Current step tracking
    let currentStep = 1;
    
    // Generate QR code in format: QR_USERNAME_RANDOMNUMBER
    function generateQRCodeData(username) {
        const randomNumber = Math.floor(1000 + Math.random() * 9000); // 4-digit random number
        return `QR_${username.toUpperCase()}_${randomNumber}`;
    }
    
    // Show error message
    function showError(message) {
        if (errorAlert) {
            errorAlert.textContent = message;
            errorAlert.style.display = "block";
        }
        if (successAlert) {
            successAlert.style.display = "none";
        }
    }
    
    // Show success message
    function showSuccess(message) {
        if (successAlert) {
            successAlert.textContent = message;
            successAlert.style.display = "block";
        }
        if (errorAlert) {
            errorAlert.style.display = "none";
        }
    }
    
    // Hide all alerts
    function hideAlerts() {
        if (errorAlert) errorAlert.style.display = "none";
        if (successAlert) successAlert.style.display = "none";
    }
    
    // Validate step 1 with stronger rules
    function validateStep1() {
        let isValid = true;

        // Reset errors
        document.querySelectorAll('.error-text').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.form-control').forEach(el => el.classList.remove('error'));

        // Validate first name
        const fname = document.getElementById("fname").value.trim();
        if (!/^[A-Za-z]{2,}$/.test(fname)) {
            document.getElementById("fnameError").textContent = "First name must be at least 2 letters (no numbers)";
            document.getElementById("fnameError").style.display = "block";
            document.getElementById("fname").classList.add("error");
            isValid = false;
        }

        // Validate last name
        const lname = document.getElementById("lname").value.trim();
        if (!/^[A-Za-z]{2,}$/.test(lname)) {
            document.getElementById("lnameError").textContent = "Last name must be at least 2 letters (no numbers)";
            document.getElementById("lnameError").style.display = "block";
            document.getElementById("lname").classList.add("error");
            isValid = false;
        }

        // Validate email format
        const email = document.getElementById("email").value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email || !emailRegex.test(email)) {
            document.getElementById("emailError").style.display = "block";
            document.getElementById("email").classList.add("error");
            isValid = false;
        }

        // Validate username
        const uname = document.getElementById("uname").value.trim();
        if (!/^[A-Za-z0-9_]{4,}$/.test(uname)) {
            document.getElementById("unameError").textContent = "Username must be at least 4 characters (letters, numbers, underscore only)";
            document.getElementById("unameError").style.display = "block";
            document.getElementById("uname").classList.add("error");
            isValid = false;
        }

        // Validate password strength
        const password = document.getElementById("password").value;
        const passRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?#&]).{6,}$/;
        if (!passRegex.test(password)) {
            document.getElementById("passwordError").textContent = "Password must be at least 6 chars, include upper, lower, number & symbol";
            document.getElementById("passwordError").style.display = "block";
            document.getElementById("password").classList.add("error");
            isValid = false;
        }

        // Validate confirm password
        const confirmPassword = document.getElementById("confirmPassword").value;
        if (password !== confirmPassword) {
            document.getElementById("confirmPasswordError").style.display = "block";
            document.getElementById("confirmPassword").classList.add("error");
            isValid = false;
        }

        return isValid;
    }

    // Validate step 2
    function validateStep2() {
        const membershipType = document.getElementById("membershipType").value;
        if (!membershipType) {
            document.getElementById("membershipError").style.display = "block";
            return false;
        }
        return true;
    }
    
    // Validate step 3
    function validateStep3() {
        const paymentMethod = document.getElementById("paymentMethod").value;
        if (!paymentMethod) {
            document.getElementById("paymentMethodError").style.display = "block";
            document.getElementById("paymentMethod").classList.add("error");
            return false;
        }
        return true;
    }
    
    // Navigate to step
    function goToStep(step) {
        // Hide all steps
        document.querySelectorAll('.form-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Show current step
        document.getElementById(`step${step}`).classList.add('active');
        
        // Update progress bar
        if (progressBar) {
            progressBar.className = `progress-bar step-${step}`;
        }
        
        // Update active step indicator
        document.querySelectorAll('.progress-step').forEach((el, index) => {
            if (index + 1 <= step) {
                el.classList.add('active');
            } else {
                el.classList.remove('active');
            }
        });
        
        currentStep = step;
        
        // Update summary in step 3
        if (step === 3) {
            updateSummary();
        }
    }
    
    // Update summary in step 3
    function updateSummary() {
        const fname = document.getElementById("fname");
        const lname = document.getElementById("lname");
        const email = document.getElementById("email");
        const uname = document.getElementById("uname");
        const gender = document.getElementById("gender");
        const membershipType = document.getElementById("membershipType");

        if (fname && lname) {
            document.getElementById("summaryName").textContent = `${fname.value} ${lname.value}`;
        }
        if (email) {
            document.getElementById("summaryEmail").textContent = email.value;
        }
        if (uname) {
            document.getElementById("summaryUsername").textContent = uname.value;
        }
        if (gender) {
            document.getElementById("summaryGender").textContent = gender.value || "Not specified";
        }
        
        if (membershipType && membershipType.value) {
            document.getElementById("summaryMembership").textContent = membershipType.value;
            
            // Calculate price based on membership type
            let price = 0;
            if (membershipType.value === "Monthly") price = 300;
            if (membershipType.value === "Student Monthly") price = 250;
            if (membershipType.value === "Day Pass") price = 50;
            
            document.getElementById("summaryPrice").textContent = `R${price}`;
            
            // Set dates
            const startDate = new Date();
            const endDate = new Date();
            
            if (membershipType.value === "Day Pass") {
                endDate.setDate(endDate.getDate() + 1);
            } else {
                endDate.setMonth(endDate.getMonth() + 1);
            }
            
            document.getElementById("summaryStartDate").textContent = formatDate(startDate);
            document.getElementById("summaryEndDate").textContent = formatDate(endDate);
        }
    }
    
    // Format date
    function formatDate(date) {
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return date.toLocaleDateString(undefined, options);
    }
    
    // Show loading state on button
    function setLoading(button, isLoading) {
        if (!button) return;
        
        const btnText = button.querySelector('.btn-text');
        if (isLoading) {
            button.disabled = true;
            if (btnText) {
                btnText.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processing...`;
            }
        } else {
            button.disabled = false;
            if (btnText) {
                btnText.textContent = 'Complete Registration';
            }
        }
    }
    
    // Event Listeners
    document.addEventListener("DOMContentLoaded", function() {
        const nextToStep2 = document.getElementById("nextToStep2");
        const nextToStep3 = document.getElementById("nextToStep3");
        const prevToStep1 = document.getElementById("prevToStep1");
        const prevToStep2 = document.getElementById("prevToStep2");
        const registrationForm = document.getElementById("registrationForm");
        
        if (nextToStep2) {
            nextToStep2.addEventListener("click", () => {
                if (validateStep1()) {
                    goToStep(2);
                    hideAlerts();
                }
            });
        }
        
        if (nextToStep3) {
            nextToStep3.addEventListener("click", () => {
                if (validateStep2()) {
                    goToStep(3);
                    hideAlerts();
                }
            });
        }
        
        if (prevToStep1) {
            prevToStep1.addEventListener("click", () => {
                goToStep(1);
                hideAlerts();
            });
        }
        
        if (prevToStep2) {
            prevToStep2.addEventListener("click", () => {
                goToStep(2);
                hideAlerts();
            });
        }
        
        // Membership option selection
        document.querySelectorAll(".membership-option").forEach(option => {
            option.addEventListener("click", () => {
                document.querySelectorAll(".membership-option").forEach(opt => {
                    opt.classList.remove("selected");
                });
                
                option.classList.add("selected");
                document.getElementById("membershipType").value = option.getAttribute("data-value");
                document.getElementById("membershipError").style.display = "none";
            });
        });
        
        // Form submission
        if (registrationForm) {
            registrationForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                
                if (!validateStep3()) {
                    return;
                }
                
                setLoading(submitBtn, true);
                hideAlerts();
                
                try {
                    // Get form values
                    const fname = document.getElementById("fname").value;
                    const lname = document.getElementById("lname").value;
                    const email = document.getElementById("email").value;
                    const uname = document.getElementById("uname").value;
                    const gender = document.getElementById("gender").value;
                    const password = document.getElementById("password").value;
                    const membershipType = document.getElementById("membershipType").value;
                    const paymentMethod = document.getElementById("paymentMethod").value;
                    
                    // Generate QR code data
                    const qrcode = generateQRCodeData(uname);
                    
                    // Calculate dates and price
                    const startDate = new Date();
                    const endDate = new Date();
                    
                    if (membershipType === "Day Pass") {
                        endDate.setDate(endDate.getDate() + 1);
                    } else {
                        endDate.setMonth(endDate.getMonth() + 1);
                    }
                    
                    let amount = 0;
                    if (membershipType === "Monthly") amount = 300;
                    if (membershipType === "Student Monthly") amount = 250;
                    if (membershipType === "Day Pass") amount = 50;
                    
                    // Insert into member table WITH QR CODE
                    const { data: memberData, error: memberError } = await supabase
                        .from("member")
                        .insert([
                            {
                                fname: fname,
                                lname: lname,
                                email: email,
                                uname: uname,
                                gender: gender,
                                password: password, // ⚠️ hash this in production
                                qrcode: qrcode // ✅ QR code stored in database
                            }
                        ])
                        .select();

                    if (memberError) {
                        console.error("Error inserting member:", memberError);
                        showError("Error saving member data: " + memberError.message);
                        setLoading(submitBtn, false);
                        return;
                    }

                    const memberid = memberData[0].memberid;

                    // Insert into membership table
                    const { error: membershipError } = await supabase
                        .from("membership")
                        .insert([
                            {
                                memberid: memberid,
                                type: membershipType,
                                status: "active",
                                startdate: startDate.toISOString().split('T')[0],
                                enddate: endDate.toISOString().split('T')[0]
                            }
                        ]);

                    if (membershipError) {
                        console.error("Error inserting membership:", membershipError);
                        showError("Error saving membership data: " + membershipError.message);
                        setLoading(submitBtn, false);
                        return;
                    }

                    // Insert into payment table
                    const { error: paymentError } = await supabase
                        .from("payment")
                        .insert([
                            {
                                memberid: memberid,
                                amount: amount,
                                paymentdate: new Date().toISOString().split('T')[0],
                                method: paymentMethod,
                                status: "paid"
                            }
                        ]);

                    if (paymentError) {
                        console.error("Error inserting payment:", paymentError);
                        showError("Error saving payment data: " + paymentError.message);
                        setLoading(submitBtn, false);
                        return;
                    }

                    // Success
                    showSuccess("Registration successful! Your account has been created. QR Code: " + qrcode);
                    
                    // Redirect to login page after 3 seconds
                    setTimeout(() => {
                        window.location.href = "member-login.html";
                    }, 3000);
                    
                } catch (error) {
                    console.error("Registration error:", error);
                    showError("An error occurred during registration. Please try again.");
                    setLoading(submitBtn, false);
                }
            });
        }

        // Focus on first name field
        const fnameField = document.getElementById("fname");
        if (fnameField) {
            fnameField.focus();
        }
    });
</script>