<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Body Tone Gym - Member Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      /* Your existing CSS styles remain the same */
      :root {
        --primary: #2c3e50;
        --secondary: #3498db;
        --accent: #657680;
        --light: #ecf0f1;
        --dark: #2c3e50;
        --success: #2ecc71;
        --warning: #f39c12;
        --error: #e74c3c;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f7fa;
        color: #333;
        line-height: 1.6;
      }
              
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header {
        background: linear-gradient(135deg, #572f32, #14191f);
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        font-size: 20px;
      }

      .user-info {
        display: flex;
        align-items: center;
      }

      .user-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: var(--secondary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 10px;
      }

      .logout-btn {
        background: var(--secondary);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        margin-left: 15px;
      }
      .checkin-Btn {
        background: var(--secondary);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        margin-left: 15px;
      }
      .booking-Btn {
        background: var(--secondary);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        margin-left: 15px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      @media (max-width: 900px) {
        .container {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: white;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .card-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--dark);
        padding-bottom: 10px;
        border-bottom: 2px solid #eee;
      }

      .profile-section {
        display: flex;
        align-items: center;
        margin-bottom: 25px;
      }

      .profile-img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--secondary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        font-weight: bold;
        margin-right: 20px;
      }

      .profile-info h2 {
        margin-bottom: 5px;
        color: var(--dark);
      }

      .profile-info p {
        color: #666;
      }

      .detail-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }

      .detail-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .detail-label {
        font-weight: 600;
        color: #666;
      }

      .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-active {
        background: #e6f7ee;
        color: var(--success);
      }

      .status-inactive {
        background: #ffe6e6;
        color: var(--error);
      }

      .status-pending {
        background: #fef5e6;
        color: var(--warning);
      }

      .qr-container {
        text-align: center;
        margin: 20px 0;
      }

      #qrcode {
        display: inline-block;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .payment-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      .payment-table th,
      .payment-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      .payment-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: var(--dark);
      }

      .payment-table tr:hover {
        background: #f8f9fa;
      }

      .payment-status-paid {
        color: var(--success);
        font-weight: 600;
      }

      .payment-status-pending {
        color: var(--warning);
        font-weight: 600;
      }

      .payment-status-failed {
        color: var(--error);
        font-weight: 600;
      }

      .no-payments {
        text-align: center;
        padding: 30px;
        color: #999;
        font-style: italic;
      }

      .loading {
        text-align: center;
        padding: 30px;
        color: #666;
      }

      .loading i {
        display: block;
        font-size: 30px;
        margin-bottom: 10px;
        color: var(--secondary);
      }

      .error-container {
        text-align: center;
        padding: 30px;
        color: var(--error);
      }

      .error-container i {
        font-size: 40px;
        margin-bottom: 15px;
      }

      .error-container button {
        margin-top: 15px;
        padding: 10px 20px;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .placeholder {
        background: #f0f0f0;
        border-radius: 4px;
        animation: pulse 1.5s infinite;
      }

      .placeholder-text {
        height: 16px;
        margin-bottom: 8px;
        width: 80%;
      }

      .placeholder-text.short {
        width: 50%;
      }

      .placeholder-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Body Tone Gym</h1>
      <div class="user-info">
        <div class="user-avatar" id="userAvatar"></div>
        <span id="userName"></span>
        <button class="logout-btn" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>

    <div class="container">
      <div id="errorDisplay" class="error-container" style="display: none; grid-column: 1 / -1">
        <i class="fas fa-exclamation-circle"></i>
        <h2>Authentication Error</h2>
        <p>We couldn't retrieve your member information. Please log in again.</p>
        <button id="loginRedirectBtn">Go to Login Page</button>
      </div>

      <div class="card">
        <h2 class="card-title">Member Profile</h2>
        <div class="profile-section">
          <div class="profile-img placeholder placeholder-circle" id="profileImg"></div>
          <div class="profile-info">
            <h2 class="placeholder placeholder-text" id="memberName"></h2>
            <p class="placeholder placeholder-text short" id="memberEmail"></p>
          </div>
        </div>
        <div class="detail-item">
          <span class="detail-label">Member ID:</span>
          <span class="placeholder placeholder-text short" id="memberId"></span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Username:</span>
          <span class="placeholder placeholder-text short" id="memberUsername"></span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Gender:</span>
          <span class="placeholder placeholder-text short" id="memberGender"></span>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Membership & QR Code</h2>
          <div>
            <button class="checkin-Btn" id="CheckinBtn">
              <i class="fas fa-sign-in-alt"></i> Checkin
            </button>
            <button class="booking-Btn" id="bookingBtn">
              <i class="fas fa-calendar-alt"></i> Bookings
            </button>
          </div>
        </div>
        <div class="detail-item">
          <span class="detail-label">Membership Type:</span>
          <span class="placeholder placeholder-text short" id="membershipType"></span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Status:</span>
          <span class="placeholder placeholder-text short" id="membershipStatus"></span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Start Date:</span>
          <span class="placeholder placeholder-text short" id="membershipStart"></span>
        </div>
        <div class="detail-item">
          <span class="detail-label">End Date:</span>
          <span class="placeholder placeholder-text short" id="membershipEnd"></span>
        </div>
        <div class="qr-container">
          <div id="qrcode" class="placeholder" style="width: 180px; height: 180px"></div>
        </div>
      </div>

      <div class="card" style="grid-column: 1 / -1">
        <h2 class="card-title">Payment History</h2>
        <div id="paymentsLoading" class="loading">
          <i class="fas fa-spinner fa-spin"></i>
          Loading payment history...
        </div>
        <div id="paymentsContainer" style="display: none">
          <table class="payment-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="paymentsTableBody"></tbody>
          </table>
          <div id="noPayments" class="no-payments" style="display: none">
            No payment history found.
          </div>
        </div>
      </div>
    </div>

   <!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script>
const SUPABASE_URL = "https://bxufacemathzdfqzmlad.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4dWZhY2VtYXRoemRmcXptbGFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMTg0NTYsImV4cCI6MjA3Mzg5NDQ1Nn0.BFogsvLqjVH_TX-WsOcFYl0AopUkELwN0BhuJ2O0lwU";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentMember = null;
let currentAttendance = null;
let attendanceHistory = [];

document.addEventListener("DOMContentLoaded", async () => {
  try {
    // Use "user" key for login persistence
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || !user.id) {
      window.location.href = "member-login.html";
      return;
    }
    currentMember = user;

    // Display member info
    const name = `${user.fname || ''} ${user.lname || ''}`.trim();
    document.getElementById("userName").textContent = name;
    document.getElementById("userAvatar").textContent = name ? name[0].toUpperCase() : 'M';

    // Get QR code data from database column
    await generateQRCodeFromDatabase(user.id);

    // Check attendance and load history
    await checkCurrentAttendance();
    await loadAttendanceHistory();

  } catch (err) {
    console.error("Init error:", err);
    showError("Failed to initialize check-in system. Please try again.");
  }
});

// Get QR code from database column
async function generateQRCodeFromDatabase(memberId) {
  try {
    const { data: member, error } = await supabase
      .from("member")
      .select("qrcode")
      .eq("memberid", memberId)
      .single();

    if (error) {
      console.error("Error fetching QR code:", error);
      showError("Failed to load QR code data.");
      return;
    }

    if (member && member.qrcode) {
      // Use the QR code data from the database column
      generateQRCode(member.qrcode);
    } else {
      showError("No QR code data found for this member.");
    }
  } catch (err) {
    console.error("QR code fetch error:", err);
    showError("Error loading QR code data.");
  }
}

// Check current attendance
async function checkCurrentAttendance() {
  try {
    const { data: attendance, error } = await supabase
      .from("attendance")
      .select("*")
      .eq("memberid", currentMember.id)
      .is("checkouttime", null)
      .order("checkintime", { ascending: false })
      .limit(1);

    if (error) throw error;

    if (attendance && attendance.length > 0) {
      currentAttendance = attendance[0];
      updateUIForCheckedIn();
    } else {
      currentAttendance = null;
      updateUIForCheckedOut();
    }
  } catch (err) {
    console.error("Check attendance error:", err);
    currentAttendance = null;
    updateUIForCheckedOut();
  }
}

// UI updates
function updateUIForCheckedIn() {
  const checkinTime = new Date(currentAttendance.checkintime);
  document.getElementById("statusIndicator").className = "status-indicator status-checked-in";
  document.getElementById("statusIndicator").innerHTML = '<i class="fas fa-user-check"></i>';
  document.getElementById("statusMessage").textContent = "You are checked in";
  document.getElementById("statusTime").textContent = `Since ${checkinTime.toLocaleString()}`;

  document.getElementById("checkinBtn").style.display = "none";
  document.getElementById("checkoutBtn").style.display = "inline-flex";
  document.getElementById("disabledBtn").style.display = "none";
}

function updateUIForCheckedOut() {
  document.getElementById("statusIndicator").className = "status-indicator status-checked-out";
  document.getElementById("statusIndicator").innerHTML = '<i class="fas fa-user"></i>';
  document.getElementById("statusMessage").textContent = "You are checked out";
  document.getElementById("statusTime").textContent = "Ready for your next workout!";

  document.getElementById("checkinBtn").style.display = "inline-flex";
  document.getElementById("checkoutBtn").style.display = "none";
  document.getElementById("disabledBtn").style.display = "none";
}

// Check-in
async function checkIn() {
  setLoading();
  try {
    const { data, error } = await supabase.from("attendance").insert([{
      memberid: currentMember.id,
      checkintime: new Date().toISOString(),
      isoffline: false,
      synced: true
    }]).select();

    if (error) throw error;
    currentAttendance = data[0];
    updateUIForCheckedIn();
    await loadAttendanceHistory();
    showSuccess("Successfully checked in!");
  } catch (err) {
    console.error(err);
    showError("Failed to check in.");
    updateUIForCheckedOut();
  }
}

// Check-out
async function checkOut() {
  setLoading();
  try {
    const { data, error } = await supabase
      .from("attendance")
      .update({ checkouttime: new Date().toISOString() })
      .eq("attendanceid", currentAttendance.attendanceid)
      .select();
    if (error) throw error;

    currentAttendance = null;
    updateUIForCheckedOut();
    await loadAttendanceHistory();
    showSuccess("Successfully checked out!");
  } catch (err) {
    console.error(err);
    showError("Failed to check out.");
    updateUIForCheckedIn();
  }
}

// Load attendance history
async function loadAttendanceHistory() {
  try {
    const { data: history, error } = await supabase
      .from("attendance")
      .select("*")
      .eq("memberid", currentMember.id)
      .order("checkintime", { ascending: false })
      .limit(10);
    if (error) throw error;

    attendanceHistory = history || [];
    document.getElementById("historyLoading").style.display = "none";
    document.getElementById("historyContainer").style.display = "block";
    document.getElementById("noHistory").style.display = attendanceHistory.length === 0 ? "block" : "none";

    if (attendanceHistory.length > 0) displayAttendanceHistory(attendanceHistory);
  } catch (err) {
    console.error(err);
    document.getElementById("historyLoading").style.display = "none";
    document.getElementById("historyContainer").style.display = "block";
    document.getElementById("noHistory").style.display = "block";
  }
}

// Display attendance history
function displayAttendanceHistory(history) {
  const tbody = document.getElementById("historyTableBody");
  tbody.innerHTML = "";

  history.forEach(record => {
    const checkin = new Date(record.checkintime);
    const checkout = record.checkouttime ? new Date(record.checkouttime) : null;

    let duration = "-";
    if (checkout) {
      const mins = Math.floor((checkout - checkin)/60000);
      duration = mins >= 60 ? `${Math.floor(mins/60)}h ${mins%60}m` : `${mins}m`;
    }

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${checkin.toLocaleDateString()}</td>
      <td>${checkin.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</td>
      <td>${checkout ? checkout.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : "-"}</td>
      <td>${duration}</td>
      <td><span class="${checkout ? "status-completed":"status-inprogress"}">${checkout ? "Completed":"In Progress"}</span></td>
    `;
    tbody.appendChild(row);
  });
}

// Generate QR code - FIXED VERSION
function generateQRCode(qrData) {
  const qrContainer = document.getElementById("qrcode");
  if (!qrContainer) return;
  
  qrContainer.innerHTML = "";
  
  // Create canvas element for QR code
  const canvas = document.createElement("canvas");
  qrContainer.appendChild(canvas);
  
  // Generate QR code with proper error handling
  QRCode.toCanvas(canvas, qrData, { 
    width: 200, 
    margin: 2,
    color: {
      dark: "#2c3e50",
      light: "#FFFFFF"
    },
    errorCorrectionLevel: 'M'
  }, function(err) {
    if (err) {
      console.error("QR generation error:", err);
      // Fallback: display text if QR generation fails
      qrContainer.innerHTML = `
        <div style="width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; 
                   background: #f8f9fa; border: 1px dashed #ccc; border-radius: 5px; color: #666;">
          <div style="text-align: center;">
            <i class="fas fa-qrcode" style="font-size: 40px; margin-bottom: 10px;"></i>
            <div>QR Code Error</div>
          </div>
        </div>
      `;
    }
  });
}

// Loading state
function setLoading() {
  document.getElementById("checkinBtn").style.display = "none";
  document.getElementById("checkoutBtn").style.display = "none";
  document.getElementById("disabledBtn").style.display = "inline-flex";
}

// Messages
function showSuccess(msg) {
  const s = document.getElementById("successAlert");
  s.textContent = msg; s.style.display="block";
  document.getElementById("errorAlert").style.display="none";
  setTimeout(()=>s.style.display="none",5000);
}
function showError(msg) {
  const e = document.getElementById("errorAlert");
  e.textContent = msg; e.style.display="block";
  document.getElementById("successAlert").style.display="none";
}

// Event listeners
document.getElementById("checkinBtn").addEventListener("click", checkIn);
document.getElementById("checkoutBtn").addEventListener("click", checkOut);
document.getElementById("backBtn").addEventListener("click", ()=>window.location.href="member-dashboard.html");
document.getElementById("logoutBtn").addEventListener("click", ()=>{
  localStorage.removeItem("user");
  window.location.href="member-login.html";
});
</script>